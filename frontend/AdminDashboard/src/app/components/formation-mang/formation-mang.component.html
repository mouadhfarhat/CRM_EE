<div class="hold-transition dark-mode sidebar-mini layout-fixed layout-navbar-fixed layout-footer-fixed">
  <div class="wrapper">
    <div class="content-wrapper">
      <!-- Header -->
      <div class="content-header">
        <div class="container-fluid">
          <div class="row mb-2">
            <div class="col-sm-6">
              <h1 class="m-0">Formation Management</h1>
            </div>
            <div class="col-sm-6">
              <ol class="breadcrumb float-sm-right">
                <li class="breadcrumb-item"><a href="#">Home</a></li>
                <li class="breadcrumb-item active">Formations</li>
              </ol>
            </div>
          </div>
        </div>
      </div>

      <!-- Main Content -->
      <div class="container mt-4">
        <div class="row">
          <div class="col-12">
            <div class="input-group mb-3">
              <input type="text" class="form-control" placeholder="Search formations..." [(ngModel)]="searchTerm" (input)="filterFormations()" />
            </div>
            <div class="d-flex justify-content-end flex-wrap gap-2 mb-3">
              <button class="btn btn-info d-flex align-items-center gap-2" (click)="showFoodCompanyDialog()">
                <i class="fa fa-cutlery"></i>
                <span>Add Food Company</span>
              </button>
              <button class="btn btn-warning d-flex align-items-center gap-2" (click)="showCategoryDialog()">
                <i class="fa fa-tags"></i>
                <span>Add Category</span>
              </button>
              <button class="btn btn-success d-flex align-items-center gap-2" (click)="showFormateurDialog()">
                <i class="fa fa-user-plus"></i>
                <span>Add Formateur</span>
              </button>
              <button class="btn btn-primary d-flex align-items-center gap-2" (click)="showFormationDialog()">
                <i class="fa fa-plus"></i>
                <span>Add Formation</span>
              </button>
            </div>
          </div>
        </div>

        <!-- Formateur Dialog -->
        <p-dialog header="Add Formateur" [(visible)]="displayFormateurDialog" [modal]="true" [style]="{width: '400px'}">
          <div class="p-field">
            <label for="firstname">First Name</label>
            <input type="text" pInputText id="firstname" class="form-control" [(ngModel)]="newFormateur.firstname" required />
          </div>
          <div class="p-field">
            <label for="lastname">Last Name</label>
            <input type="text" pInputText id="lastname" class="form-control" [(ngModel)]="newFormateur.lastname" required />
          </div>
          <div class="p-field">
            <label for="email">Email</label>
            <input type="email" pInputText id="email" class="form-control" [(ngModel)]="newFormateur.email" required />
          </div>
          <div class="p-field">
            <label for="phoneNumber">Phone Number</label>
            <input type="text" pInputText id="phoneNumber" class="form-control" [(ngModel)]="newFormateur.phoneNumber" required />
          </div>
          <div class="d-flex justify-content-end mt-3">
            <button pButton type="button" label="Cancel" class="p-button-secondary mr-2" (click)="displayFormateurDialog=false"></button>
            <button pButton type="button" label="Add" class="p-button-primary" (click)="submitFormateur()"></button>
          </div>
        </p-dialog>

        <!-- Category Dialog -->
        <p-dialog header="Add Category" [(visible)]="displayCategoryDialog" [modal]="true" [style]="{width: '400px'}">
          <div class="p-field">
            <label for="categoryName">Name</label>
            <input type="text" pInputText id="categoryName" class="form-control" [(ngModel)]="newCategory.name" required />
          </div>
          <div class="d-flex justify-content-end mt-3">
            <button pButton type="button" label="Cancel" class="p-button-secondary mr-2" (click)="displayCategoryDialog=false"></button>
            <button pButton type="button" label="Add" class="p-button-primary" (click)="submitCategory()"></button>
          </div>
        </p-dialog>

        <!-- FoodCompany Dialog -->
        <p-dialog header="Add Food Company" [(visible)]="displayFoodCompanyDialog" [modal]="true" [style]="{width: '400px'}">
          <div class="p-field">
            <label for="foodCompanyName">Name</label>
            <input type="text" pInputText id="foodCompanyName" class="form-control" [(ngModel)]="newFoodCompany.name" required />
          </div>
          <div class="p-field">
            <label for="contactInfo">Contact Info</label>
            <input type="text" pInputText id="contactInfo" class="form-control" [(ngModel)]="newFoodCompany.contactInfo" />
          </div>
          <div class="d-flex justify-content-end mt-3">
            <button pButton type="button" label="Cancel" class="p-button-secondary mr-2" (click)="displayFoodCompanyDialog=false"></button>
            <button pButton type="button" label="Add" class="p-button-primary" (click)="submitFoodCompany()"></button>
          </div>
        </p-dialog>

        <!-- Formation Dialog -->
        <p-dialog [header]="isEditMode ? 'Edit Formation' : 'Add Formation'" [(visible)]="displayFormationDialog" [modal]="true" [style]="{width: '500px'}">
          <div class="p-field">
            <label for="formationName">Name</label>
            <input type="text" pInputText id="formationName" class="form-control" [(ngModel)]="newFormation.name" required />
          </div>
          <div class="p-field">
            <label for="formationTitle">Title</label>
            <input type="text" pInputText id="formationTitle" class="form-control" [(ngModel)]="newFormation.title" required />
          </div>
          <div class="p-field">
            <label for="description">Description</label>
            <textarea pInputTextarea id="description" class="form-control" [(ngModel)]="newFormation.description" required></textarea>
          </div>
          <div class="p-field">
            <label for="dateDebut">Start Date</label>
            <input type="date" pInputText id="dateDebut" class="form-control" [(ngModel)]="newFormation.dateDebut" required />
          </div>
          <div class="p-field">
            <label for="dateFin">End Date</label>
            <input type="date" pInputText id="dateFin" class="form-control" [(ngModel)]="newFormation.dateFin" required />
          </div>
          <div class="p-field">
            <label for="registrationEndDate">Registration Deadline</label>
            <input type="date" pInputText id="registrationEndDate" class="form-control" [(ngModel)]="newFormation.registrationEndDate" required />
          </div>
          <div class="p-field">
            <label for="price">Price</label>
            <input type="number" pInputText id="price" class="form-control" [(ngModel)]="newFormation.price" />
          </div>
          <div class="p-field">
            <label for="category">Category</label>
            <p-dropdown id="category" [options]="categories" [(ngModel)]="newFormation.category" optionLabel="name" placeholder="Select a category" [filter]="true" (onFilter)="onSearchCategories($event)" [filterBy]="'name'" required>
            </p-dropdown>
          </div>
          <div class="p-field">
            <label for="formateur">Formateur</label>
            <p-dropdown id="formateur" [options]="formateurs" [(ngModel)]="newFormation.formateur" optionLabel="firstname" placeholder="Select a formateur" [filter]="true" (onFilter)="onSearchFormateurs($event)" [filterBy]="'firstname,lastname'" required>
            </p-dropdown>
          </div>
          <div class="p-field">
            <label for="foodCompany">Food Company</label>
            <p-dropdown id="foodCompany" [options]="foodCompanies" [(ngModel)]="newFormation.foodCompany" optionLabel="name" placeholder="Select a food company" [filter]="true" (onFilter)="onSearchFoodCompanies($event)" [filterBy]="'name'" required>
            </p-dropdown>
          </div>
          <div class="p-field">
            <label for="image">Image (Optional)</label>
            <input type="file" id="image" class="form-control" (change)="onImageSelect($event)" accept="image/*" />
          </div>
          <div class="p-field">
            <label for="file">Syllabus File (Optional)</label>
            <input type="file" id="file" class="form-control" (change)="onFileSelect($event)" accept="application/pdf" />
          </div>
          <div class="d-flex justify-content-end mt-3">
            <button pButton type="button" label="Cancel" class="p-button-secondary mr-2" (click)="displayFormationDialog=false"></button>
            <button pButton type="button" [label]="isEditMode ? 'Update' : 'Add'" class="p-button-primary" (click)="submitFormation()"></button>
          </div>
        </p-dialog>

<div style="max-height: 65vh; overflow-y: auto; padding-right: 10px;" class="custom-scrollbar">
  <div class="row g-3" *ngFor="let formation of formations">
    <div class="col-12">
      <div class="card p-4 shadow-sm rounded border border-secondary-subtle bg-dark text-light formation-card">
        <!-- Header: Title + Buttons -->
        <div class="d-flex justify-content-between align-items-center mb-3">
          <h4 class="text-info fw-bold mb-0">
            <i class="fa fa-graduation-cap me-2"></i> {{ formation.title }}
          </h4>

          <div class="btn-group">
            <button class="btn btn-outline-light" title="Download" (click)="downloadFile(formation)" *ngIf="formation.fileName">
              <i class="fa fa-download"></i>
            </button>
            <button class="btn btn-outline-success" title="Edit" (click)="showFormationDialog(formation)">
              <i class="fa fa-edit"></i>
            </button>
            <button class="btn btn-outline-danger" title="Delete" (click)="deleteFormation(formation.id)">
              <i class="fa fa-trash"></i>
            </button>
          </div>
        </div>

        <!-- Description -->
<!-- Description -->
<p class="text-muted">
  <ng-container *ngIf="formation.id !== null">
    <span *ngIf="!isExpanded(formation.id)">
      {{ formation.description.length > 150 ? (formation.description | slice: 0:150) + '...' : formation.description }}
    </span>
    <span *ngIf="isExpanded(formation.id)">
      {{ formation.description }}
    </span>
    <a *ngIf="formation.description.length > 150" href="#" (click)="toggleDescription(formation.id); $event.preventDefault()" class="text-warning ms-2">
      {{ isExpanded(formation.id) ? 'View less' : 'View more' }}
    </a>
  </ng-container>
  <ng-container *ngIf="formation.id === null">
    {{ formation.description }}
  </ng-container>
</p>

        <!-- Info Grid -->
        <div class="row text-sm">
          <div class="col-md-4">
            <p><i class="fa fa-dollar-sign text-success me-3"></i> <strong>Price:</strong> ${{ formation.price || 'N/A' }}</p>
            <p><i class="fa fa-calendar-plus text-info me-3"></i> <strong>Start:</strong> {{ formation.dateDebut | date: 'd MMM y' }}</p>
            <p><i class="fa fa-calendar-check text-info me-3"></i> <strong>Register By:</strong> {{ formation.registrationEndDate | date: 'd MMM y' }}</p>
          </div>

          <div class="col-md-4">
            <p><i class="fa fa-chalkboard-teacher text-warning me-3"></i> <strong>Trainer:</strong> {{ formation.formateur?.firstname }} {{ formation.formateur?.lastname }}</p>
            <p><i class="fa fa-calendar-times text-danger me-3"></i> <strong>End:</strong> {{ formation.dateFin | date: 'd MMM y' }}</p>
            <p>
              <i class="fa fa-star text-warning me-3"></i>
              <strong>Rating:</strong>
              <span class="text-warning" *ngFor="let star of [].constructor(Math.round(formation.averageRating ?? 0)); let i = index">
                <i class="fa fa-star"></i>
              </span>
              {{ formation.averageRating || 'N/A' }}
            </p>
          </div>

          <div class="col-md-4">
            <p><i class="fa fa-utensils text-light me-3"></i> <strong>Food Partner:</strong> {{ formation.foodCompany?.name }}</p>
            <p *ngIf="formation.fileName">
              <i class="fa fa-file-pdf text-danger me-3"></i>
              <a [href]="'http://localhost:8080/files/' + formation.fileName" target="_blank" class="text-light text-decoration-underline">
                {{ formation.fileName }}
              </a>
            </p>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

      </div>
    </div>
  </div>
</div>

<!-- Toast for notifications -->
<p-toast></p-toast>

<!-- Confirm Dialog -->
<p-confirmDialog [style]="{width: '425px'}" key="confirm" [baseZIndex]="10000"></p-confirmDialog>